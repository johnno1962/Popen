//
//  Repo: https://github.com/johnno1962/Popen
//  $Id: //depot/Popen/Tests/PopenTests/PopenTests.swift#6 $
//
import XCTest
@testable import Popen

final class PopenTests: XCTestCase {
    func testExample() throws {
        // XCTest Documentation
        // https://developer.apple.com/documentation/xctest

        // Defining Test Cases and Test Methods
        // https://developer.apple.com/documentation/xctest/defining_test_cases_and_test_methods

        { () -> () in
            let testFile = "/tmp/popen.test.txt"

            Fopen(path: testFile, mode: .write)?.print("Hello Test")

            if let fp = Popen(cmd: "/usr/bin/wc -w "+testFile,
                              mode: .other("r+")) {
                // This could work but doesn't
                fp.print("Hello Test")
                fp.flush()

                XCTAssertEqual(fp.readLine(),
                               "       2 "+testFile,
                               "Command output")
            } else {
                XCTFail("Could not open process r/w")
            }

            #if !os(Linux)
            XCTAssert(Int(Date().timeIntervalSince1970) -
                      (Fstat(path: testFile)?
                .st_mtimespec.tv_sec ?? 0) < 60, "file recent")
            #endif

            XCTAssertEqual(Array(Glob(pattern: "/tmp/popen.test.*")!),
                           [testFile], "file count")

            guard let inp = Popen(cmd: "/bin/ls /tmp"),
                  let out = Popen(cmd: "/usr/bin/wc", mode: .write) else {
                return XCTFail("Could not open processes")
            }

            var lines = 0
            while let line = inp.readLine() {
                out.print(line)
                lines += 1
            }
            XCTAssertNotEqual(lines, 0,
                              "Lines transferred")
        }()

        if let cat = Qopen(cmd: "cat") {
            cat.terminate()
            while let line = cat.readLine() {
                print(line)
            }
        }

        XCTAssertEqual(Popen.openFILEStreams, 0, "All closed")

        Fopen.STDOUT.print("STANDARD OUTPUT")
        Fopen.STDERR.print("STANDARD ERROR")

        XCTAssertEqual(Popen.openFILEStreams, 2, "Two open")

        // https://github.com/johnno1962/Popen/issues/1
        for _ in 0..<10 {
            if let infinite = Popen(cmd: "ls -lR /", mode: .read) {
                print(infinite.readLine() ?? "NOLINE")
                print(infinite.terminatedOK())
            }
        }
        for _ in 0..<10 {
            let infinite = Topen(exec: "/bin/ls", arguments: ["-lR", "/"])
            print(infinite.readLine() ?? "NOLINE")
            print(infinite.terminatedOK())
        }
    }
}
