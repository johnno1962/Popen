import XCTest
@testable import Popen

final class PopenTests: XCTestCase {
    func testExample() throws {
        // XCTest Documentation
        // https://developer.apple.com/documentation/xctest

        // Defining Test Cases and Test Methods
        // https://developer.apple.com/documentation/xctest/defining_test_cases_and_test_methods

        {
            let testFile = "/tmp/popen.txt"

            Fopen(path: testFile, mode: .write)?.print("Hello Test")

            guard let fp = Popen(cmd: "wc -w "+testFile,
                                 mode: .both) else {
                return XCTFail("Could not open process")
            }

            // This could work but doesn't
            fp.print("Hello Test")
            fp.flush()

            XCTAssertEqual(fp.readLine(),
                           "       2 "+testFile,
                           "Command output")

            guard let inp = Popen(cmd: "/bin/ls /tmp"),
                  let out = Popen(cmd: "/usr/bin/wc", mode: .write) else {
                return XCTFail("Could not open processes")
            }

            var lines = 0
            while let line = inp.readLine() {
                out.print(line)
                lines += 1
            }
            XCTAssertNotEqual(lines, 0,
                              "Lines transferred")
        }()

        XCTAssertEqual(openFILEStreams, 0, "All closed")
    }
}
